{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4 animate__animated animate__fadeIn">New Range Visit</h2>

<form method="POST" enctype="multipart/form-data" class="animate__animated animate__fadeInLeft">
    <div class="mb-3">
        <label for="visit_date" class="form-label">Date (YYYY-MM-DD)</label>
        <input 
            type="text" 
            class="form-control" 
            name="visit_date"
            placeholder="2025-03-20"
            required 
        />
    </div>
    <div class="mb-3">
        <label for="range_id" class="form-label">Range</label>
        <select class="form-select" name="range_id" required>
            <option value="" disabled selected>Select a range</option>
            {% for r in all_ranges %}
            <option value="{{ r.id }}">{{ r.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="ammo_used" class="form-label">Ammo Used</label>
        <input 
            type="number" 
            class="form-control" 
            name="ammo_used" 
            required 
        />
    </div>

    <!-- Dynamic rounds -->
    <div id="rounds-wrapper">
        <!-- Fields for rounds will be generated by JS -->
    </div>

    <input type="hidden" id="round_count" name="round_count" value="0"/>

    <button 
        type="button" 
        class="btn btn-secondary mb-3" 
        onclick="addRound()"
    >
        + New Round
    </button>
    <br/>
    <button type="submit" class="btn btn-custom">
        Save
    </button>
</form>

<script>
let roundIndex = 0;

function addRound() {
    roundIndex++;
    const wrapper = document.getElementById('rounds-wrapper');
    const roundDiv = document.createElement('div');
    roundDiv.className = 'card p-3 mb-3';

    roundDiv.innerHTML = `
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label" for="gun_${roundIndex}">Gun</label>
                <select class="form-select" name="gun_${roundIndex}" required>
                    <option value="" disabled selected>Select a gun</option>
                    {% for g in all_guns %}
                    <option value="{{ g.id }}">{{ g.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label" for="target_${roundIndex}">Target</label>
                <select class="form-select" name="target_${roundIndex}" required>
                    <option value="" disabled selected>Select a target</option>
                    {% for t in all_targets %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label" for="distance_${roundIndex}">Distance</label>
                <select class="form-select" name="distance_${roundIndex}">
                    <option value="10" selected>10m</option>
                    <option value="15">15m</option>
                    <option value="20">20m</option>
                    <option value="25">25m</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label" for="score_${roundIndex}">Score</label>
                <input 
                    type="number" 
                    step="0.01" 
                    class="form-control" 
                    name="score_${roundIndex}" 
                    placeholder="e.g. 45.5" 
                    required
                />
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label" for="photo_${roundIndex}">Target photo (optional)</label>
            <input 
                type="file" 
                class="form-control" 
                name="photo_${roundIndex}" 
                accept="image/*"
            />
        </div>
    `;
    wrapper.appendChild(roundDiv);

    document.getElementById('round_count').value = roundIndex;
}
</script>
{% endblock %}
